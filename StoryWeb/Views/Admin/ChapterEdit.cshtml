@model StoryWeb.Models.ModelView.Chapter
@{
    ViewBag.Title = "Sửa chương";
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
}

<div class="container-fluid">
    <h2 class="mb-4">Sửa chương</h2>
    <a href="@Url.Action("StoryDetail", "Admin", new { id = Model.StoryId })" class="btn btn-secondary mb-3">
        <i class="fas fa-arrow-left"></i> Quay lại
    </a>

    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger">@TempData["Error"]</div>
    }
    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success">@TempData["Success"]</div>
    }

    @using (Html.BeginForm("ChapterEditConfirm", "Admin", FormMethod.Post, new { enctype = "multipart/form-data" }))
    {
        @Html.HiddenFor(m => m.Id)
        @Html.HiddenFor(m => m.StoryId)
        <div class="form-group mb-3">
            <label for="Title">Tiêu đề:</label>
            @Html.TextBoxFor(m => m.Title, new { @class = "form-control", required = "required" })
            @Html.ValidationMessageFor(m => m.Title, "", new { @class = "text-danger" })
        </div>
        <div class="form-group mb-3">
            <label for="Content">Nội dung (cho truyện chữ):</label>
            @Html.TextAreaFor(m => m.Content, new { @class = "form-control", rows = "5" })
            @Html.ValidationMessageFor(m => m.Content, "", new { @class = "text-danger" })
        </div>
        <div class="form-group mb-3">
            <label>Ảnh hiện tại (cho truyện hình):</label>
            @if (Model.ImageCount > 0)
            {
                <div id="existingImages">
                    @foreach (var image in ViewBag.Images ?? new System.Collections.Generic.List<dynamic>())
                    {
                        <div class="image-container mb-2">
                            <img src="@image.FullPath" alt="Ảnh" class="img-thumbnail" style="max-width: 150px; max-height: 150px;">
                            <a href="@Url.Action("DeleteImage", "Admin", new { chapterId = Model.Id, imageId = image._id })" class="btn btn-danger btn-sm mt-1" onclick="return confirm('Bạn có chắc muốn xóa ảnh này?')">
                                <i class="fas fa-trash"></i>
                            </a>
                            <input type="file" name="images" class="form-control-file mt-1" accept="image/*" data-image-id="@image._id">
                        </div>
                    }
                </div>
            }
            else
            {
                <p>Chưa có ảnh.</p>
            }
        </div>
        <div class="form-group mb-3">
            <label>Thêm ảnh mới (kéo thả hoặc chọn file):</label>
            <div class="dropzone" id="imageDropzone">
                <input type="file" name="images" class="form-control-file" multiple accept="image/*" />
                <p>Kéo thả ảnh hoặc nhấp để chọn (JPG, PNG)</p>
            </div>
        </div>
        <button type="submit" class="btn btn-primary">Cập nhật chương</button>
    }
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.3/dropzone.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.3/dropzone.min.css">
    <script>
        $(document).ready(function () {
            Dropzone.autoDiscover = false;
            $("#imageDropzone").dropzone({
                url: "@Url.Action("ChapterEditConfirm", "Admin")",
                paramName: "images",
                maxFilesize: 10,
                acceptedFiles: "image/jpeg,image/png",
                autoProcessQueue: false,
                uploadMultiple: true,
                parallelUploads: 10,
                init: function () {
                    var myDropzone = this;
                    $("#imageDropzone input").change(function (e) {
                        myDropzone.processQueue();
                    });
                    this.on("successmultiple", function (files, response) {
                        if (response.success) {
                            alert("Upload thành công!");
                            location.reload();
                        } else {
                            alert("Upload thất bại!");
                        }
                    });
                }
            });

            // Lấy danh sách ảnh hiện tại
            @if (Model.ImageCount > 0)
            {
                @:$.get("@Url.Action("GetChapterImages", "Admin", new { chapterId = Model.Id })", function(data) {
                @:    var images = data;
                @:    var container = $("#existingImages");
                @:    container.empty();
                @:    $.each(images, function(index, image) {
                @:        container.append('<div class="image-container mb-2"><img src="' + image.FullPath + '" alt="Ảnh" class="img-thumbnail" style="max-width: 150px; max-height: 150px;"><a href="@Url.Action("DeleteImage", "Admin", new { chapterId = Model.Id })?imageId=' + image._id + '" class="btn btn-danger btn-sm mt-1" onclick="return confirm(\'Bạn có chắc muốn xóa ảnh này?\')"><i class="fas fa-trash"></i></a><input type="file" name="images" class="form-control-file mt-1" accept="image/*" data-image-id="' + image._id + '"></div>');
                @:    });
                @:});
            }
        });

        // Xử lý thay đổi ảnh
        $("input[type='file'][name='images']").change(function () {
            var imageId = $(this).data("image-id");
            var formData = new FormData();
            formData.append("image", $(this)[0].files[0]);
            $.ajax({
                url: "@Url.Action("UpdateImage", "Admin", new { chapterId = Model.Id })?imageId=" + imageId,
                type: "PUT",
                data: formData,
                contentType: false,
                processData: false,
                success: function (response) {
                    alert("Cập nhật ảnh thành công!");
                    location.reload();
                },
                error: function () {
                    alert("Cập nhật ảnh thất bại!");
                }
            });
        });
    </script>
}

@* Thêm action GetChapterImages trong AdminController *@
@{
    ViewBag.Images = null; // Sẽ được thay thế bằng dữ liệu từ action
}